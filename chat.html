<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" type="text/css" href="style/main.css"/>
    <style>
        main article {
            display: flex;
            flex-direction: column;
            flex-basis: 80%; /* use 80% of the screens width */
            background: aliceblue;
        }

        div#chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: auto;
        }

        main form {
            display: flex;
            min-height: 15%;
        }

        main textarea {
            display: flex;
            flex-basis: 100%;
        }

        main section {
            margin: 5px 10px 5px 10px; /* margin goes clockwise, top -> right -> bottom -> left */
        }

        main aside {
            overflow: auto; /* display scrollbar if content overflows the available space */
        }

        footer {
            display: flex;
            justify-content: center;
            background: lightcoral;
        }
    </style>
    <title>Chat</title>
</head>
<body>
<header>
    <h1>Chat</h1>
    <nav>
        <ul>
            <li>
                <a href="chat.html">Chat</a>
            </li>
            <li>
                <a href="about.html">About</a>
            </li>
            <li>
                <a href="profile.html">Profile</a>
            </li>
            <li>
                <a href="index.html">Logout</a>
            </li>
        </ul>
    </nav>
</header>
<main>
    <article>
        <div id="chat">
        </div>
        <form id="chatMessage">
            <textarea name="message" id="message"></textarea>
            <input type="submit" value="Send"/>
        </form>
    </article>
    <aside>
        <h2>Users</h2>
        <ul id="users">
        </ul>
    </aside>
</main>
<footer id="serverStatus">
    Server is currently offline...
</footer>
</body>
<script src="app/user.js"></script>
<script src="app/chat.js"></script>
<script>
    // DOM elements
    let chatElem = document.getElementById('chat');
    let chatForm = document.getElementById('chatMessage');

    let myUser = new user.User();
    let myChat = new chat.Chat(myUser, chatElem);
    let userMap = new Map();

    // helper which inserts a new chat message into the DOM
    function insertMessage(msg) {
        let newMessageElem = document.createElement('section');
        newMessageElem.innerHTML = `> ${userMap.get(msg.user_id)}@${msg.timestamp} <br /> ${msg.message} <br /><hr />`;
        chatElem.appendChild(newMessageElem);
        chatElem.scrollTop = chatElem.scrollHeight;
    }

    // load all Users from the server, and create the user List
    myUser.getAllUsers().then(users => {
        let userListElem = document.getElementById('users');

        // append a list item for each user
        for (let user of users) {
            userMap.set(user.id, user.nickname);

            let newUserElem = document.createElement('li');
            newUserElem.draggable = true; // make the li element draggable
            newUserElem.innerHTML = `${user.nickname} (${user.status})`;
            userListElem.appendChild(newUserElem);
        }
    }).catch(err => {
        alert(`Fehler beim laden der User: ${err}`)
    });

    // load all the Messages
    myChat.loadMessages().then(messages => {
        for (let msg of messages.reverse()) {
            insertMessage(msg);
        }
    }).catch(err => {
        alert(`Fehler beim laden der Nachrichten ${err}`)
    });

    // Websocket stuff
    myChat.webSocket.onmessage = function (event) {
        let wsEvent = JSON.parse(event.data);
        if (wsEvent.action === 'message_added') {
            insertMessage(wsEvent.data);
        }
    };

    // submit a new message
    chatForm.addEventListener('submit', function (event) {
        event.preventDefault();
        let messageElem = document.getElementById('message');
        myChat.sendMessage(messageElem.value).then(resp =>{
            messageElem.value = "";
        }).catch(err => {
            alert(`Fehler beim senden der Nachricht: ${err}`)
        });
    });


    /*
    function serverIsOnline() {
        let footerElem = document.getElementById('serverStatus');
        footerElem.innerHTML = 'Server is online!';
        footerElem.style = 'background-color: green;'
    }

    function serverIsOffline() {
        let footerElem = document.getElementById('serverStatus');
        footerElem.innerHTML = 'Server is currently offline...';
        footerElem.style = 'background-color: lightcoral;';
    }
    */
</script>
</html>